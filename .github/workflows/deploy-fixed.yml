name: Deploy Laravel to AWS Elastic Beanstalk

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, dom, fileinfo, mysql, zip
        coverage: none
        
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-
          
    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction
      
    - name: Create deployment package
      run: |
        echo "🚀 Creando paquete de despliegue..."
        echo "📋 Información del deployment:"
        echo "  - SHA: ${{ github.sha }}"
        echo "  - Run Number: ${{ github.run_number }}"
        echo "  - Branch: ${{ github.ref_name }}"
        echo "  - Version Label: ${{ github.sha }}-${{ github.run_number }}-${{ github.ref_name }}"
        
        # Crear directorio de despliegue
        mkdir -p deploy-package
        
        # Copiar archivos necesarios para Laravel
        echo "📦 Copiando archivos de Laravel..."
        cp -r app bootstrap config database public resources routes storage vendor composer.json composer.lock artisan deploy-package/
        
        # NO copiar archivos .env - las variables se manejan en Elastic Beanstalk
        
        # Validar archivos críticos
        echo "🔍 Validando archivos críticos..."
        if [ ! -f "deploy-package/artisan" ]; then
          echo "❌ Error: artisan no encontrado"
          exit 1
        fi
        if [ ! -f "deploy-package/composer.json" ]; then
          echo "❌ Error: composer.json no encontrado"
          exit 1
        fi
        echo "✅ Archivos críticos validados correctamente"
        
        # Crear archivos de configuración de Elastic Beanstalk
        echo "⚙️ Creando configuración de Elastic Beanstalk..."
        mkdir -p deploy-package/.ebextensions
        
        # Crear Dockerfile para Elastic Beanstalk
        cat > deploy-package/Dockerfile << 'EOF'
        FROM php:8.3-fpm
        
        # Instalar dependencias del sistema
        RUN apt-get update && apt-get install -y \
            git curl libpng-dev libonig-dev libxml2-dev \
            zip unzip libzip-dev libfreetype6-dev libjpeg62-turbo-dev \
            libmcrypt-dev libgd-dev nginx supervisor \
            && apt-get clean && rm -rf /var/lib/apt/lists/*
        
        # Instalar extensiones PHP
        RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
            && docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd zip
        
        # Configurar directorio de trabajo
        WORKDIR /var/www/html
        
        # Copiar aplicación
        COPY . .
        
        # Copiar configuración de PHP
        COPY php.ini /usr/local/etc/php/conf.d/custom.ini
        
        # Configurar permisos
        RUN chown -R www-data:www-data storage bootstrap/cache \
            && chmod -R 775 storage bootstrap/cache
        
        # Configurar Nginx
        RUN echo 'server {' > /etc/nginx/sites-available/default && \
            echo '    listen 80;' >> /etc/nginx/sites-available/default && \
            echo '    index index.php index.html;' >> /etc/nginx/sites-available/default && \
            echo '    root /var/www/html/public;' >> /etc/nginx/sites-available/default && \
            echo '    location / {' >> /etc/nginx/sites-available/default && \
            echo '        try_files \$uri \$uri/ /index.php?\$query_string;' >> /etc/nginx/sites-available/default && \
            echo '    }' >> /etc/nginx/sites-available/default && \
            echo '    location ~ \.php$ {' >> /etc/nginx/sites-available/default && \
            echo '        fastcgi_pass 127.0.0.1:9000;' >> /etc/nginx/sites-available/default && \
            echo '        fastcgi_index index.php;' >> /etc/nginx/sites-available/default && \
            echo '        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;' >> /etc/nginx/sites-available/default && \
            echo '        include fastcgi_params;' >> /etc/nginx/sites-available/default && \
            echo '    }' >> /etc/nginx/sites-available/default && \
            echo '}' >> /etc/nginx/sites-available/default
        
        # Configurar Supervisor
        RUN echo '[supervisord]' > /etc/supervisor/conf.d/supervisord.conf && \
            echo 'nodaemon=true' >> /etc/supervisor/conf.d/supervisord.conf && \
            echo '[program:php-fpm]' >> /etc/supervisor/conf.d/supervisord.conf && \
            echo 'command=php-fpm' >> /etc/supervisor/conf.d/supervisord.conf && \
            echo 'autostart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
            echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
            echo '[program:nginx]' >> /etc/supervisor/conf.d/supervisord.conf && \
            echo 'command=nginx -g "daemon off;"' >> /etc/supervisor/conf.d/supervisord.conf && \
            echo 'autostart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
            echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf
        
        EXPOSE 80
        CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
        EOF
        
        # Crear configuración de PHP para Docker (no usar option_settings)
        cat > deploy-package/php.ini << 'EOF'
        memory_limit = 512M
        max_execution_time = 300
        upload_max_filesize = 40M
        post_max_size = 40M
        max_input_vars = 3000
        EOF
        
        # Configuración de logs
        cat > deploy-package/.ebextensions/02-logs.config << 'EOF'
        option_settings:
          aws:elasticbeanstalk:cloudwatch:logs:
            StreamLogs: true
            DeleteOnTerminate: false
            RetentionInDays: 7
        EOF
        
        # Configuración simplificada - solo comandos esenciales
        cat > deploy-package/.ebextensions/03-migrations.config << 'EOF'
        container_commands:
          01_permissions:
            command: "chmod -R 775 storage bootstrap/cache"
            leader_only: true
          02_storage_link:
            command: "php artisan storage:link"
            leader_only: true
        EOF
        
        # Configuración de permisos simplificada
        cat > deploy-package/.ebextensions/04-permissions.config << 'EOF'
        container_commands:
          01_ownership:
            command: "chown -R webapp:webapp storage bootstrap/cache"
            leader_only: true
        EOF
        
        # Crear Dockerrun.aws.json
        cat > deploy-package/Dockerrun.aws.json << 'EOF'
        {
          "AWSEBDockerrunVersion": "1",
          "Image": {
            "Name": "php:8.3-fpm",
            "Update": "true"
          },
          "Ports": [
            {
              "ContainerPort": "80"
            }
          ],
          "Volumes": [
            {
              "HostDirectory": "/var/app/current/storage",
              "ContainerDirectory": "/var/www/html/storage"
            }
          ],
          "Logging": "/var/log/nginx"
        }
        EOF
        
        # Comprimir el paquete
        echo "📦 Comprimiendo paquete de despliegue..."
        cd deploy-package && zip -r ../deployment-package.zip . && cd ..
        
        echo "✅ Paquete de despliegue creado exitosamente!"
        
    - name: Deploy to Elastic Beanstalk
      uses: einaregilsson/beanstalk-deploy@v20
      with:
        aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        application_name: cldci-staging
        environment_name: cldci-staging-env-new
        region: us-east-1
        version_label: ${{ github.sha }}-${{ github.run_number }}-${{ github.ref_name }}
        deployment_package: deployment-package.zip
        use_existing_version_if_available: true
        wait_for_environment_recovery: 300
        
    - name: Deployment Success Notification
      if: success()
      run: |
        echo "✅ Deployment completed successfully!"
        echo "🚀 Application deployed to: [URL will be generated after deployment]"
        
    - name: Deployment Failure Notification
      if: failure()
      run: |
        echo "❌ Deployment failed!"
        echo "Please check the logs above for more details."
